version: "3.7"
services:
  mariadb:
    image: docker.io/mariadb:10.6
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed # Temporary fix for MariaDB 10.6
    environment:
      MYSQL_ROOT_PASSWORD: 123
    volumes:
      - mariadb-data:/var/lib/mysql

  redis-cache:
    image: docker.io/redis:alpine

  redis-queue:
    image: docker.io/redis:alpine

  frappe:
    image: frappe/erpnext:v15.42.0
    deploy:
      restart_policy:
        condition: on-failure
    command:
      - nginx-entrypoint.sh
    environment:
      - SHELL=/bin/bash
    volumes:
      - frappe_docker_testvolume:/workspace:cached
      # Enable if you require git cloning
      # - ${HOME}/.ssh:/home/frappe/.ssh
    working_dir: /workspace/installation
    ports:
      - 8080:8080
      - 8010-8015:8000-8005
      - 9010-9015:9000-9005

  configurator-create-site:
    image: frappe/erpnext:v15.42.0
    deploy:
      restart_policy:
        condition: none
    entrypoint:
      - bash
      - -c
    # add redis_socketio for backward compatibility
    command:
      - >
        whoami;
        ls -la ..;
        if [ ! -d frappe-bench ]; then
          cp -R /home/frappe/frappe-bench ./
          cd frappe-bench;
          ls -1 apps > sites/apps.txt;
          bench set-config -g db_host $$DB_HOST;
          bench set-config -gp db_port $$DB_PORT;
          bench set-config -g redis_cache "redis://$$REDIS_CACHE";
          bench set-config -g redis_queue "redis://$$REDIS_QUEUE";
          bench set-config -g redis_socketio "redis://$$REDIS_QUEUE";
          bench set-config -gp socketio_port $$SOCKETIO_PORT;

          wait-for-it -t 120 db:3306;
          wait-for-it -t 120 redis-cache:6379;
          wait-for-it -t 120 redis-queue:6379;
          export start=`date +%s`;
          until [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".db_host // empty"` ]] && \
            [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".redis_cache // empty"` ]] && \
            [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".redis_queue // empty"` ]];
          do
            echo "Waiting for sites/common_site_config.json to be created";
            sleep 5;
            if (( `date +%s`-start > 120 )); then
              echo "could not find sites/common_site_config.json with required keys";
              exit 1
            fi
          done;
          echo "sites/common_site_config.json found";
          bench new-site --no-mariadb-socket --admin-password=admin --db-root-password=admin --install-app erpnext --set-default frontend;
        fi;
    environment:
      DB_HOST: db
      DB_PORT: "3306"
      REDIS_CACHE: redis-cache:6379
      REDIS_QUEUE: redis-queue:6379
      SOCKETIO_PORT: "9000"
    volumes:
      - frappe_docker_testvolume:/workspace:cached
      # Enable if you require git cloning
      # - ${HOME}/.ssh:/home/frappe/.ssh
    working_dir: /workspace/installation

volumes:
  mariadb-data:
  frappe_docker_testvolume:
    external: true
